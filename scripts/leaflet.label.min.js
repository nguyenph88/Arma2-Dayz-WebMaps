/*
	Leaflet.label, a plugin that adds labels to markers and vectors for Leaflet powered maps.
	(c) 2012-2013, Jacob Toye, Smartrak

	https://github.com/Leaflet/Leaflet.label
	http://leafletjs.com
	https://github.com/jacobtoye
*/

(function(e,t,n){L.labelVersion="0.2.2-dev";L.Label=L.Class.extend({includes:L.Mixin.Events,options:{className:"",clickable:false,direction:"right",noHide:false,offset:[12,-15],opacity:1,zoomAnimation:true},initialize:function(e,t){L.setOptions(this,e);this._source=t;this._animated=L.Browser.any3d&&this.options.zoomAnimation;this._isOpen=false},onAdd:function(e){this._map=e;this._pane=this._source instanceof L.Marker?e._panes.markerPane:e._panes.popupPane;if(!this._container){this._initLayout()}this._pane.appendChild(this._container);this._initInteraction();this._update();this.setOpacity(this.options.opacity);e.on("moveend",this._onMoveEnd,this).on("viewreset",this._onViewReset,this);if(this._animated){e.on("zoomanim",this._zoomAnimation,this)}if(L.Browser.touch&&!this.options.noHide){L.DomEvent.on(this._container,"click",this.close,this)}},onRemove:function(e){this._pane.removeChild(this._container);e.off({zoomanim:this._zoomAnimation,moveend:this._onMoveEnd,viewreset:this._onViewReset},this);this._removeInteraction();this._map=null},setLatLng:function(e){this._latlng=L.latLng(e);if(this._map){this._updatePosition()}return this},setContent:function(e){this._previousContent=this._content;this._content=e;this._updateContent();return this},close:function(){var e=this._map;if(e){if(L.Browser.touch&&!this.options.noHide){L.DomEvent.off(this._container,"click",this.close)}e.removeLayer(this)}},updateZIndex:function(e){this._zIndex=e;if(this._container&&this._zIndex){this._container.style.zIndex=e}},setOpacity:function(e){this.options.opacity=e;if(this._container){L.DomUtil.setOpacity(this._container,e)}},_initLayout:function(){this._container=L.DomUtil.create("div","leaflet-label "+this.options.className+" leaflet-zoom-animated");this.updateZIndex(this._zIndex)},_update:function(){if(!this._map){return}this._container.style.visibility="hidden";this._updateContent();this._updatePosition();this._container.style.visibility=""},_updateContent:function(){if(!this._content||!this._map||this._prevContent===this._content){return}if(typeof this._content==="string"){this._container.innerHTML=this._content;this._prevContent=this._content;this._labelWidth=this._container.offsetWidth}},_updatePosition:function(){var e=this._map.latLngToLayerPoint(this._latlng);this._setPosition(e)},_setPosition:function(e){var t=this._map,n=this._container,r=t.latLngToContainerPoint(t.getCenter()),i=t.layerPointToContainerPoint(e),s=this.options.direction,o=this._labelWidth,u=L.point(this.options.offset);if(s==="right"||s==="auto"&&i.x<r.x){L.DomUtil.addClass(n,"leaflet-label-right");L.DomUtil.removeClass(n,"leaflet-label-left");e=e.add(u)}else{L.DomUtil.addClass(n,"leaflet-label-left");L.DomUtil.removeClass(n,"leaflet-label-right");e=e.add(L.point(-u.x-o,u.y))}L.DomUtil.setPosition(n,e)},_zoomAnimation:function(e){var t=this._map._latLngToNewLayerPoint(this._latlng,e.zoom,e.center).round();this._setPosition(t)},_onMoveEnd:function(){if(!this._animated||this.options.direction==="auto"){this._updatePosition()}},_onViewReset:function(e){if(e&&e.hard){this._update()}},_initInteraction:function(){if(!this.options.clickable){return}var e=this._container,t=["dblclick","mousedown","mouseover","mouseout","contextmenu"];L.DomUtil.addClass(e,"leaflet-clickable");L.DomEvent.on(e,"click",this._onMouseClick,this);for(var n=0;n<t.length;n++){L.DomEvent.on(e,t[n],this._fireMouseEvent,this)}},_removeInteraction:function(){if(!this.options.clickable){return}var e=this._container,t=["dblclick","mousedown","mouseover","mouseout","contextmenu"];L.DomUtil.removeClass(e,"leaflet-clickable");L.DomEvent.off(e,"click",this._onMouseClick,this);for(var n=0;n<t.length;n++){L.DomEvent.off(e,t[n],this._fireMouseEvent,this)}},_onMouseClick:function(e){if(this.hasEventListeners(e.type)){L.DomEvent.stopPropagation(e)}this.fire(e.type,{originalEvent:e})},_fireMouseEvent:function(e){this.fire(e.type,{originalEvent:e});if(e.type==="contextmenu"&&this.hasEventListeners(e.type)){L.DomEvent.preventDefault(e)}if(e.type!=="mousedown"){L.DomEvent.stopPropagation(e)}else{L.DomEvent.preventDefault(e)}}});L.BaseMarkerMethods={showLabel:function(){if(this.label&&this._map){this.label.setLatLng(this._latlng);this._map.showLabel(this.label)}return this},hideLabel:function(){if(this.label){this.label.close()}return this},setLabelNoHide:function(e){if(this._labelNoHide===e){return}this._labelNoHide=e;if(e){this._removeLabelRevealHandlers();this.showLabel()}else{this._addLabelRevealHandlers();this.hideLabel()}},bindLabel:function(e,t){var n=this.options.icon?this.options.icon.options.labelAnchor:this.options.labelAnchor,r=L.point(n)||L.point(0,0);r=r.add(L.Label.prototype.options.offset);if(t&&t.offset){r=r.add(t.offset)}t=L.Util.extend({offset:r},t);this._labelNoHide=t.noHide;if(!this.label){if(!this._labelNoHide){this._addLabelRevealHandlers()}this.on("remove",this.hideLabel,this).on("move",this._moveLabel,this).on("add",this._onMarkerAdd,this);this._hasLabelHandlers=true}this.label=(new L.Label(t,this)).setContent(e);return this},unbindLabel:function(){if(this.label){this.hideLabel();this.label=null;if(this._hasLabelHandlers){if(!this._labelNoHide){this._removeLabelRevealHandlers()}this.off("remove",this.hideLabel,this).off("move",this._moveLabel,this).off("add",this._onMarkerAdd,this)}this._hasLabelHandlers=false}return this},updateLabelContent:function(e){if(this.label){this.label.setContent(e)}},getLabel:function(){return this.label},_onMarkerAdd:function(){if(this._labelNoHide){this.showLabel()}},_addLabelRevealHandlers:function(){this.on("mouseover",this.showLabel,this).on("mouseout",this.hideLabel,this);if(L.Browser.touch){this.on("click",this.showLabel,this)}},_removeLabelRevealHandlers:function(){this.off("mouseover",this.showLabel,this).off("mouseout",this.hideLabel,this);if(L.Browser.touch){this.off("click",this.showLabel,this)}},_moveLabel:function(e){this.label.setLatLng(e.latlng)}};L.Icon.Default.mergeOptions({labelAnchor:new L.Point(9,-20)});L.Marker.mergeOptions({icon:new L.Icon.Default});L.Marker.include(L.BaseMarkerMethods);L.Marker.include({_originalUpdateZIndex:L.Marker.prototype._updateZIndex,_updateZIndex:function(e){var t=this._zIndex+e;this._originalUpdateZIndex(e);if(this.label){this.label.updateZIndex(t)}},_originalSetOpacity:L.Marker.prototype.setOpacity,setOpacity:function(e,t){this.options.labelHasSemiTransparency=t;this._originalSetOpacity(e)},_originalUpdateOpacity:L.Marker.prototype._updateOpacity,_updateOpacity:function(){var e=this.options.opacity===0?0:1;this._originalUpdateOpacity();if(this.label){this.label.setOpacity(this.options.labelHasSemiTransparency?this.options.opacity:e)}},_originalSetLatLng:L.Marker.prototype.setLatLng,setLatLng:function(e){if(this.label&&!this._labelNoHide){this.hideLabel()}return this._originalSetLatLng(e)}});L.CircleMarker.mergeOptions({labelAnchor:new L.Point(0,0)});L.CircleMarker.include(L.BaseMarkerMethods);L.Path.include({bindLabel:function(e,t){if(!this.label||this.label.options!==t){this.label=new L.Label(t,this)}this.label.setContent(e);if(!this._showLabelAdded){this.on("mouseover",this._showLabel,this).on("mousemove",this._moveLabel,this).on("mouseout remove",this._hideLabel,this);if(L.Browser.touch){this.on("click",this._showLabel,this)}this._showLabelAdded=true}return this},unbindLabel:function(){if(this.label){this._hideLabel();this.label=null;this._showLabelAdded=false;this.off("mouseover",this._showLabel,this).off("mousemove",this._moveLabel,this).off("mouseout remove",this._hideLabel,this)}return this},updateLabelContent:function(e){if(this.label){this.label.setContent(e)}},_showLabel:function(e){this.label.setLatLng(e.latlng);this._map.showLabel(this.label)},_moveLabel:function(e){this.label.setLatLng(e.latlng)},_hideLabel:function(){this.label.close()}});L.Map.include({showLabel:function(e){return this.addLayer(e)}});L.FeatureGroup.include({clearLayers:function(){this.unbindLabel();this.eachLayer(this.removeLayer,this);return this},bindLabel:function(e,t){return this.invoke("bindLabel",e,t)},unbindLabel:function(){return this.invoke("unbindLabel")},updateLabelContent:function(e){this.invoke("updateLabelContent",e)}})})(this,document)